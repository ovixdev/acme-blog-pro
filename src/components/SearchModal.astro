---
// src/components/SearchModal.astro

import { getCollection } from 'astro:content';
import { filterDrafts, buildUrl } from '../utils';

const posts = await getCollection('posts');
const filteredPosts = filterDrafts(posts);

const searchIndex = filteredPosts.map((post) => ({
  title: post.data.title,
  description: post.data.description,
  slug: post.slug,
  tags: post.data.tags,
  author: post.data.author,
}));

const base = buildUrl('posts/');
---

<!-- Search Modal (Global) -->
<div id="search-modal" class="hidden fixed inset-0 z-[100]">
  <!-- Backdrop -->
  <div id="search-backdrop" class="absolute inset-0 bg-black/50 backdrop-blur-sm"></div>

  <!-- Modal Content -->
  <div class="relative max-w-2xl mx-auto mt-10 sm:mt-20 p-4">
    <div class="bg-white dark:bg-gray-900 rounded-xl shadow-2xl overflow-hidden">
      <!-- Search Input -->
      <div class="flex items-center gap-3 p-4 border-b border-gray-200 dark:border-gray-700">
        <svg class="w-5 h-5 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
        <input
          id="search-input"
          type="text"
          placeholder="Search posts..."
          class="flex-1 bg-transparent text-gray-900 dark:text-white placeholder-gray-400 outline-none text-lg"
          autocomplete="off"
        />
        <button id="search-close" class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 sm:hidden">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
        <kbd class="hidden sm:inline-block px-2 py-1 text-xs text-gray-500 bg-gray-100 dark:bg-gray-800 rounded">ESC</kbd>
      </div>

      <!-- Results -->
      <div id="search-results" class="max-h-[60vh] overflow-y-auto p-2">
        <p class="p-4 text-gray-500 dark:text-gray-400 text-center">Start typing to search...</p>
      </div>
    </div>
  </div>
</div>

<script is:inline define:vars={{ searchIndex, base }}>
  (function() {
    function initSearch() {
      const searchModal = document.getElementById('search-modal');
      const searchBackdrop = document.getElementById('search-backdrop');
      const searchInput = document.getElementById('search-input');
      const searchResults = document.getElementById('search-results');
      const searchClose = document.getElementById('search-close');

      if (!searchModal || !searchInput || !searchResults) return;

      window.openSearch = function() {
        searchModal.classList.remove('hidden');
        setTimeout(function() {
          searchInput.focus();
        }, 100);
        document.body.style.overflow = 'hidden';
      };

      window.closeSearch = function() {
        searchModal.classList.add('hidden');
        searchInput.value = '';
        searchResults.innerHTML = '<p class="p-4 text-gray-500 dark:text-gray-400 text-center">Start typing to search...</p>';
        document.body.style.overflow = '';
      };

      function performSearch(query) {
        if (!query.trim()) {
          searchResults.innerHTML = '<p class="p-4 text-gray-500 dark:text-gray-400 text-center">Start typing to search...</p>';
          return;
        }

        var lowerQuery = query.toLowerCase();
        var results = searchIndex.filter(function(post) {
          return (
            post.title.toLowerCase().includes(lowerQuery) ||
            post.description.toLowerCase().includes(lowerQuery) ||
            post.tags.some(function(tag) { return tag.toLowerCase().includes(lowerQuery); }) ||
            post.author.toLowerCase().includes(lowerQuery)
          );
        });

        if (results.length === 0) {
          searchResults.innerHTML = '<p class="p-4 text-gray-500 dark:text-gray-400 text-center">No posts found.</p>';
          return;
        }

        searchResults.innerHTML = results.map(function(post) {
          return '<a href="' + base + post.slug + '" class="block p-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">' +
            '<h3 class="font-semibold text-gray-900 dark:text-white mb-1">' + post.title + '</h3>' +
            '<p class="text-sm text-gray-600 dark:text-gray-400 line-clamp-2">' + post.description + '</p>' +
            '<div class="flex flex-wrap gap-2 mt-2">' +
            post.tags.map(function(tag) {
              return '<span class="text-xs text-primary-600 dark:text-primary-400">#' + tag + '</span>';
            }).join('') +
            '</div>' +
          '</a>';
        }).join('');
      }

      // Event listeners
      if (searchBackdrop) {
        searchBackdrop.addEventListener('click', window.closeSearch);
      }

      if (searchClose) {
        searchClose.addEventListener('click', window.closeSearch);
      }

      searchInput.addEventListener('input', function(e) {
        performSearch(e.target.value);
      });

      // Keyboard shortcuts
      document.addEventListener('keydown', function(e) {
        if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
          e.preventDefault();
          window.openSearch();
        }
        if (e.key === 'Escape') {
          window.closeSearch();
        }
      });
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initSearch);
    } else {
      initSearch();
    }
  })();
</script>