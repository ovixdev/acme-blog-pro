---
// src/pages/posts/[slug].astro

import { Image } from 'astro:assets';
import { getCollection, render } from 'astro:content';
import Comments from '../../components/Comments.astro';
import TableOfContents from '../../components/TableOfContents.astro';
import { getAuthorByName, getAvatarUrl } from '../../data/authors';
import BaseLayout from '../../layouts/BaseLayout.astro';
import { buildUrl, filterDrafts, formatDate, getReadingTime, getRelatedPosts } from '../../utils';

export async function getStaticPaths() {
  const posts = await getCollection('posts');
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content, headings } = await render(post);

const formattedDate = formatDate(post.data.pubDate);
const readingTime = getReadingTime(post.body || '');

// Get author data
const author = getAuthorByName(post.data.author);

// Get related posts
const allPosts = await getCollection('posts');
const relatedPosts = getRelatedPosts(post, filterDrafts(allPosts), 3);

---

<BaseLayout title={post.data.title} description={post.data.description}>
  <article class="py-12 lg:py-16">
    <div class="container-custom">
      <div class="max-w-3xl mx-auto">
        <!-- Header -->
        <header class="mb-10">
          {post.data.tags && post.data.tags.length > 0 && (
            <div class="flex flex-wrap gap-2 mb-4">
              {post.data.tags.map((tag) => (

                 <a href={buildUrl(`tags/${tag}`)}
                  class="px-3 py-1 text-sm font-medium bg-primary-100 dark:bg-primary-900/50 text-primary-700 dark:text-primary-300 rounded-full hover:bg-primary-200 dark:hover:bg-primary-800 transition-colors"
                >
                  {tag}
                </a>
              ))}
            </div>
          )}

          <h1 class="text-3xl md:text-4xl lg:text-5xl font-bold text-gray-900 dark:text-white mb-6 leading-tight">
            {post.data.title}
          </h1>

          <div class="flex items-center gap-4 pb-8 border-b border-gray-200 dark:border-gray-800">
            <div class="flex items-center gap-3">
              <a href={buildUrl(`authors/${author?.id || ''}`)} class="w-10 h-10 bg-primary-100 dark:bg-primary-900 rounded-full flex items-center justify-center overflow-hidden">
                {author?.avatar ? (
                  <img src={getAvatarUrl(author.avatar)} alt={author.name} class="w-full h-full object-cover" />
                ) : (
                  <span class="text-sm font-bold text-primary-600 dark:text-primary-400">
                    {post.data.author.charAt(0)}
                  </span>
                )}
              </a>
              <div>
                <a href={buildUrl(`authors/${author?.id || ''}`)} class="font-medium text-gray-900 dark:text-white hover:text-primary-600 dark:hover:text-primary-400 transition-colors">
                  {post.data.author}
                </a>
                <div class="flex items-center gap-2 text-sm text-gray-500 dark:text-gray-400">
                  <time datetime={post.data.pubDate.toISOString()}>{formattedDate}</time>
                  <span>â€¢</span>
                  <span>{readingTime}</span>
                </div>
              </div>
            </div>
          </div>
        </header>

                <!-- Hero Image -->
        {post.data.image && (
          <div class="aspect-video mb-10 overflow-hidden rounded-2xl bg-gray-100 dark:bg-gray-800">
            {typeof post.data.image.src === 'string' ? (
              <img
                src={post.data.image.src}
                alt={post.data.image.alt}
                class="w-full h-full object-cover"
              />
            ) : (
              <Image
                src={post.data.image.src}
                alt={post.data.image.alt}
                width={1200}
                height={675}
                class="w-full h-full object-cover"
                quality={85}
              />
            )}
          </div>
        )}

        <!-- Table of Contents -->
        <TableOfContents headings={headings} />

        <!-- Content -->
        <div class="post-content text-gray-700 dark:text-gray-300 text-lg leading-relaxed">
          <Content />
        </div>

        <!-- Related Posts -->
        {relatedPosts.length > 0 && (
          <aside class="mt-16 pt-8 border-t border-gray-200 dark:border-gray-800">
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">Related Posts</h2>
            <div class="grid gap-6">
              {relatedPosts.map((relatedPost) => (

                 <a href={buildUrl(`posts/${relatedPost.slug}`)}
                  class="block p-4 rounded-xl bg-gray-50 dark:bg-gray-900 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors"
                >
                  <h3 class="font-semibold text-gray-900 dark:text-white mb-1">
                    {relatedPost.data.title}
                  </h3>
                  <p class="text-sm text-gray-600 dark:text-gray-400 line-clamp-2">
                    {relatedPost.data.description}
                  </p>
                </a>
              ))}
            </div>
          </aside>
        )}

        <!-- Back Link -->
        <div class="mt-12 pt-8 border-t border-gray-200 dark:border-gray-800">

           <a href={buildUrl('blog')}
            class="inline-flex items-center gap-2 text-primary-600 dark:text-primary-400 hover:underline font-medium"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
            Back to all posts
          </a>
        </div>
        <!-- Comments -->
        <Comments slug={post.slug} />
      </div>
    </div>
  </article>
</BaseLayout>

<style is:global>
  .post-content h1 {
    font-size: 1.875rem;
    font-weight: 700;
    color: #111827;
    margin-top: 3rem;
    margin-bottom: 1.5rem;
  }

  .dark .post-content h1 {
    color: #fff;
  }

  .post-content h2 {
    font-size: 1.5rem;
    font-weight: 700;
    color: #111827;
    margin-top: 2.5rem;
    margin-bottom: 1rem;
  }

  .dark .post-content h2 {
    color: #fff;
  }

  .post-content h3 {
    font-size: 1.25rem;
    font-weight: 600;
    color: #111827;
    margin-top: 2rem;
    margin-bottom: 0.75rem;
  }

  .dark .post-content h3 {
    color: #fff;
  }

  .post-content p {
    margin-bottom: 1.5rem;
  }

  .post-content a {
    color: #4445e7;
    text-decoration: underline;
  }

  .post-content a:hover {
    text-decoration: none;
  }

  .dark .post-content a {
    color: #7a8ff8;
  }

  .post-content strong {
    font-weight: 600;
    color: #111827;
  }

  .dark .post-content strong {
    color: #fff;
  }

  .post-content ul,
  .post-content ol {
    margin-bottom: 1.5rem;
    padding-left: 1.5rem;
  }

  .post-content ul {
    list-style-type: disc;
  }

  .post-content ol {
    list-style-type: decimal;
  }

  .post-content li {
    margin-bottom: 0.5rem;
  }

  .post-content blockquote {
    border-left: 4px solid #5a66f2;
    padding-left: 1.5rem;
    padding-top: 0.5rem;
    padding-bottom: 0.5rem;
    margin-top: 1.5rem;
    margin-bottom: 1.5rem;
    font-style: italic;
    color: #4b5563;
    background-color: #f9fafb;
    border-radius: 0 0.5rem 0.5rem 0;
  }

  .dark .post-content blockquote {
    color: #9ca3af;
    background-color: #111827;
  }

  .post-content code {
    background-color: #f3f4f6;
    padding: 0.125rem 0.375rem;
    border-radius: 0.25rem;
    font-size: 0.875rem;
    font-family: ui-monospace, monospace;
    color: #4445e7;
  }

  .dark .post-content code {
    background-color: #1f2937;
    color: #a3b8fc;
  }

  .post-content pre {
    background-color: #111827;
    color: #f3f4f6;
    padding: 1.5rem;
    border-radius: 0.75rem;
    margin-top: 1.5rem;
    margin-bottom: 1.5rem;
    overflow-x: auto;
  }

  .dark .post-content pre {
    background-color: #030712;
  }

  .post-content pre code {
    background-color: transparent;
    padding: 0;
    color: inherit;
    font-size: 0.875rem;
  }

  .post-content hr {
    margin-top: 2.5rem;
    margin-bottom: 2.5rem;
    border-color: #e5e7eb;
  }

  .dark .post-content hr {
    border-color: #374151;
  }

  .post-content img {
    border-radius: 0.75rem;
    margin-top: 2rem;
    margin-bottom: 2rem;
  }

  .post-content > h1:first-child {
    display: none;
  }
</style>